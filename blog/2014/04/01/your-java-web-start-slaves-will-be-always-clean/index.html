<html>
<head>
<title>
Your Java Web Start slaves will be always clean
</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<meta content='Jenkins is an open source automation server' name='description'>
<link href='/css/style.css' media='screen' rel='stylesheet'>
</head>
<body>
<a href='https://github.com/jenkinsci'>
<img alt='Fork us on GitHub' src='https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png' style='position: absolute; top: 0; right: 0; border: 0;'>
</a>
<div class='clearfloat' id='head'>
<div class='clearfloat'>
<div id='logo'>
<a href='/' title='Jenkins'>
<img src='/images/header_logo.png'>
</a>
<div id='tagline'>
An extendable open source automation server
</div>
</div>
</div>
<div class='clearfloat' id='navbar'>
<div id='page-bar'>
<ul class='menu'>
<li class='leaf first'>
<a href='/node' title='Blog landing page'>
Blog
</a>
</li>
<li class='expanded'>
<a href='/' title=''>
Connect
</a>
<ul class='menu'>
<li class='leaf first'>
<a href='/content/mailing-lists' title='Browse Jenkins mailing list archives and/or subscribe to lists'>
Mailing Lists
</a>
</li>
<li class='leaf'>
<a href='/content/chat' title='Chat with the rest of the Jenkins community on IRC'>
Chat
</a>
</li>
<li class='leaf'>
<a href='http://twitter.com/jenkinsci' title='Check out @jenkinsci on Twitter'>
Twitter
</a>
</li>
<li class='leaf'>
<a href='/content/event-calendar' title='Calendar for Jenkins events'>
Event Calendar
</a>
</li>
<li class='leaf'>
<a href='https://wiki.jenkins-ci.org/display/JENKINS/Office+Hours' title='WebEx-based online meeting'>
Office Hours
</a>
</li>
<li class='leaf last'>
<a href='https://reddit.com/r/jenkinsci' title='Check out the latest links and news on jenkinsci.reddit.com!'>
reddit
</a>
</li>
</ul>
</li>
<li class='leaf'>
<a href='https://wiki.jenkins-ci.org/display/JENKINS/Issue+Tracking' title='JIRA for Jenkins'>
Bug Tracker
</a>
</li>
<li class='leaf'>
<a href='http://wiki.jenkins-ci.org/' title='Main documentation of Jenkins'>
Wiki
</a>
</li>
<li class='leaf'>
<a href='http://ci.jenkins-ci.org/' title='Jenkins and plugins built on Jenkins'>
CI
</a>
</li>
<li class='leaf'>
<a href='https://wiki.jenkins-ci.org/display/JENKINS/Donation' title=''>
Donation
</a>
</li>
<li class='leaf last'>
<a href='/content/about-jenkins-ci' title='About Jenkins CI'>
About
</a>
</li>
</ul>
</div>
</div>

</div>
<div class='clearfloat' id='page'>
<div class='clearfloat' id='top'>
<div id='sidebar'>
<div class='block block-block even' id='block-block-5'>
<h3>
What is Jenkins?
</h3>
<div class='content'>
<p>
In a nutshell, Jenkins is the leading open source automation server.
Built with Java, it provides
<strong>
hundreds
</strong>
of plugins to support building, testing, deploying and automation
virtually any project
</p>
</div>
</div>
<div class='block block-block even' id='block-block-15'>
<h3>
Download
</h3>
<div class='content'>
This is where download content goes
</div>
</div>

<div class='block block-block even' id='block-block-15'>
<div class='content'>
<center>
<a href='http://www.wakaleo.com/books/jenkins-the-definitive-guide'>
<img alt='Jenkins: The Definitive Guide' border='0' src='http://agentdero.cachefly.net/continuousblog/images/jenkins-cover-small.png' width='220'>
</a>
<br>
<a href='http://oreilly.com/catalog/0636920010326'>
<strong>
Buy the book!
</strong>
</a>
</center>
</div>
</div>

<div class='block block-block odd' id='block-block-8'>
<h3>
Resources
</h3>
<div class='content'>
<big>
<p>
<a href='/calendar'>
Calendar
</a>
</p>
<p>
<a href='https://wiki.jenkins-ci.org/'>
Wiki
</a>
</p>
<p>
<a href='https://issues.jenkins-ci.org/'>
Issues
</a>
</p>
<p>
<a href='http://ci.jenkins-ci.org/'>
Jenkins-on-Jenkins
</a>
</p>
</big>
</div>
</div>


</div>
<div class='main-content with-sidebar' id='content'>
<div id='content-top'>
<div class='node clear-block'>
<h1>
<a href='/blog/2014/04/01/your-java-web-start-slaves-will-be-always-clean/' title='Your Java Web Start slaves will be always clean'>
Your Java Web Start slaves will be always clean
</a>
</h1>
<span class='submitted'>
Published on
2014-04-01T00:00:00+00:00
</span>
<div style='float: right; clear: all;'>
<a class='twitter-share-button' data-lang='en' href='https://twitter.com/share'>
Tweet
</a>
</div>

<div class='content'>
<div style="float:right; margin:1em"><a href="http://en.wikipedia.org/wiki/Mr._Clean"><br/>
<img src="http://upload.wikimedia.org/wikipedia/en/thumb/7/73/Mr._Clean_logo.png/200px-Mr._Clean_logo.png"><br/>
</a></div><br/>
<br/>
<p><br/>
If you have slaves that connect through <a href="https://wiki.jenkins-ci.org/display/JENKINS/Distributed+builds#Distributedbuilds-LaunchslaveagentviaJavaWebStart">Java Web Start</a> (such as <a href="https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+as+a+Windows+service#InstallingJenkinsasaWindowsservice-InstallSlaveasaWindowsservice%28require.NET2.0framework%29">slaves installed as Windows services</a>), we have a good news for you.<br/>
<br/>
<p><br/>
In case of a connection loss, this type of slaves has been designed to automatically attempt to reconnect to the master. This makes sense because you want these slaves to remain online all the time, even if your janitor trips over the ethernet cable. Unfortunately, it also means that over the time, these slaves accumulate gunk, such as mutated static states, any left-over threads or memory leaks, or <a href="https://issues.jenkins-ci.org/browse/JENKINS-20913">native libraries that are loaded into JVM</a>.<br/>
<br/>
<p><br/>
To prevent that, a better approach is to <a href="https://issues.jenkins-ci.org/browse/JENKINS-19055">restart the slave JVM (JENKINS-19055)</a> and have the new JVM reconnect, instead of having the same JVM reconnect. That would ensure that the slave always stays clean. I've planned to make this change for a while now, and I'm happy to report that this change is finally landing to the upcoming 1.559.<br/>
<br/>
<p><br/>
Restarting JVM is easy on Unix, where I could just <a href="http://man7.org/linux/man-pages/man3/exec.3.html">exec(3)</a> to itself. We've been doing this for ages on masters, for example when you update a plugin and tell Jenkins to restart.<br/>
<br/>
<p><br/>
The hard part is to do this for Windows, where the most of the time was spent. I had to improve <a href="https://github.com/kohsuke/winsw">windows service wrapper</a> to support self-restarting services, which turned out to be trickier because Windows service control manager doesn't provide "restart" as an atomic operation. It also kills not just the service process itself but all the processes in the group. So I had to double-fork the service wrapper into a separate process group just to restart a service from within itself.<br/>
<br/>
<p><br/>
In any case, the end result is that if <a href="https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+as+a+Windows+service#InstallingJenkinsasaWindowsservice-InstallSlaveasaWindowsservice%28require.NET2.0framework%29">you have installed a service through GUI</a>, be it on Windows, Unix, or OS X, slaves will restart themselves every time it gets disconnected from the master.<br/>
<br/>
<p><br/>
I've also taken the opportunity to make <tt>jenkins-slave.exe</tt> on the slave self-updating. Every time it connects to the master, it gets the latest version from the master.<br/>
<br/>
<p><br/>
If you have installed Web Start slaves as services, make sure to update the local copy of <tt>slave.jar</tt> on these slaves to 2.37 or later. This "restart on reconnect" feature only kicks in when you are running this very recent version of <tt>slave.jar</tt>. And yes, we realize it'd be nice for <tt>slave.jar</tt> to update itself, which is tracked as <a href="https://issues.jenkins-ci.org/browse/JENKINS-22454">JENKINS-22454</a>. But that's a work for another day.<br/>
<br/>

</div>
</div>

<div id='content-bottom'>
</div>
</div>
<script>
  !function(d,s,id) {
    var js, fjs=d.getElementsByTagName(s)[0];
    if (!d.getElementById(id)) {
      js = d.createElement(s);
      js.id=id;
      js.src="//platform.twitter.com/widgets.js";
      fjs.parentNode.insertBefore(js,fjs);
    }
  }(document,"script","twitter-wjs");
</script>

<div id='github'>
<a href='https://github.com/rtyler/jenkins.io/edit/master/content//blog/2014/2014-04-01-your-java-web-start-slaves-will-be-always-clean.html'>
Improve this page
</a>
<small>
(/blog/2014/2014-04-01-your-java-web-start-slaves-will-be-always-clean.html)
</small>
</div>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){

                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),

                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)

                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-4216293-5', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

</body>
</html>
