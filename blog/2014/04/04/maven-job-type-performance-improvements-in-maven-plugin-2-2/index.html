<html>
<head>
<title>
Maven job type performance improvements in Maven plugin 2.2
</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<meta content='Jenkins is an open source automation server' name='description'>
<link href='/css/style.css' media='screen' rel='stylesheet'>
</head>
<body>
<a href='https://github.com/jenkinsci'>
<img alt='Fork us on GitHub' src='https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png' style='position: absolute; top: 0; right: 0; border: 0;'>
</a>
<div class='clearfloat' id='head'>
<div class='clearfloat'>
<div id='logo'>
<a href='/' title='Jenkins'>
<img src='/images/header_logo.png'>
</a>
<div id='tagline'>
An extendable open source automation server
</div>
</div>
</div>
<div class='clearfloat' id='navbar'>
<div id='page-bar'>
<ul class='menu'>
<li class='leaf first'>
<a href='/node' title='Blog landing page'>
Blog
</a>
</li>
<li class='expanded'>
<a href='/' title=''>
Connect
</a>
<ul class='menu'>
<li class='leaf first'>
<a href='/content/mailing-lists' title='Browse Jenkins mailing list archives and/or subscribe to lists'>
Mailing Lists
</a>
</li>
<li class='leaf'>
<a href='/content/chat' title='Chat with the rest of the Jenkins community on IRC'>
Chat
</a>
</li>
<li class='leaf'>
<a href='http://twitter.com/jenkinsci' title='Check out @jenkinsci on Twitter'>
Twitter
</a>
</li>
<li class='leaf'>
<a href='/content/event-calendar' title='Calendar for Jenkins events'>
Event Calendar
</a>
</li>
<li class='leaf'>
<a href='https://wiki.jenkins-ci.org/display/JENKINS/Office+Hours' title='WebEx-based online meeting'>
Office Hours
</a>
</li>
<li class='leaf last'>
<a href='https://reddit.com/r/jenkinsci' title='Check out the latest links and news on jenkinsci.reddit.com!'>
reddit
</a>
</li>
</ul>
</li>
<li class='leaf'>
<a href='https://wiki.jenkins-ci.org/display/JENKINS/Issue+Tracking' title='JIRA for Jenkins'>
Bug Tracker
</a>
</li>
<li class='leaf'>
<a href='http://wiki.jenkins-ci.org/' title='Main documentation of Jenkins'>
Wiki
</a>
</li>
<li class='leaf'>
<a href='http://ci.jenkins-ci.org/' title='Jenkins and plugins built on Jenkins'>
CI
</a>
</li>
<li class='leaf'>
<a href='https://wiki.jenkins-ci.org/display/JENKINS/Donation' title=''>
Donation
</a>
</li>
<li class='leaf last'>
<a href='/content/about-jenkins-ci' title='About Jenkins CI'>
About
</a>
</li>
</ul>
</div>
</div>

</div>
<div class='clearfloat' id='page'>
<div class='clearfloat' id='top'>
<div id='sidebar'>
<div class='block block-block even' id='block-block-5'>
<h3>
What is Jenkins?
</h3>
<div class='content'>
<p>
In a nutshell, Jenkins is the leading open source automation server.
Built with Java, it provides
<strong>
hundreds
</strong>
of plugins to support building, testing, deploying and automation
virtually any project
</p>
</div>
</div>
<div class='block block-block even' id='block-block-15'>
<h3>
Download
</h3>
<div class='content'>
This is where download content goes
</div>
</div>

<div class='block block-block even' id='block-block-15'>
<div class='content'>
<center>
<a href='http://www.wakaleo.com/books/jenkins-the-definitive-guide'>
<img alt='Jenkins: The Definitive Guide' border='0' src='http://agentdero.cachefly.net/continuousblog/images/jenkins-cover-small.png' width='220'>
</a>
<br>
<a href='http://oreilly.com/catalog/0636920010326'>
<strong>
Buy the book!
</strong>
</a>
</center>
</div>
</div>

<div class='block block-block odd' id='block-block-8'>
<h3>
Resources
</h3>
<div class='content'>
<big>
<p>
<a href='/calendar'>
Calendar
</a>
</p>
<p>
<a href='https://wiki.jenkins-ci.org/'>
Wiki
</a>
</p>
<p>
<a href='https://issues.jenkins-ci.org/'>
Issues
</a>
</p>
<p>
<a href='http://ci.jenkins-ci.org/'>
Jenkins-on-Jenkins
</a>
</p>
</big>
</div>
</div>


</div>
<div class='main-content with-sidebar' id='content'>
<div id='content-top'>
<div class='node clear-block'>
<h1>
<a href='/blog/2014/04/04/maven-job-type-performance-improvements-in-maven-plugin-2-2/' title='Maven job type performance improvements in Maven plugin 2.2'>
Maven job type performance improvements in Maven plugin 2.2
</a>
</h1>
<span class='submitted'>
Published on
2014-04-04T00:00:00+00:00
</span>
<div style='float: right; clear: all;'>
<a class='twitter-share-button' data-lang='en' href='https://twitter.com/share'>
Tweet
</a>
</div>

<div class='content'>
<div style="float:right; margin:1em;"><br/>
<a href="http://en.wikipedia.org/wiki/Grumman_F-14_Tomcat"><br/>
<img src="http://upload.wikimedia.org/wikipedia/commons/thumb/c/ca/US_Navy_040925-N-0295M-030_An_F-14D_Tomcat_conducts_a_high_speed_flyby_during_the_tactical_air_power_demonstration_at_the_2004_Naval_Air_Station_Oceana_Air_Show.jpg/300px-thumbnail.jpg"></a><br/>
</div><br/>
<br/>
<p><br/>
I recently had an opportunity to visit a big Jenkins user on site, and one of the things they've told me is that building projects in the Maven job type is substantially slower than doing the same with the freestyle project type.<br/>
<br/>
<p><br/>
This is partly expected, because this job type does more for you. For example, it automatically archives your build artifacts, fingerprints all the relevant information, and so on. These are good things, and naturally, it cost time.<br/>
<br/>
<p><br/>
But the slow down they are seeing was substantial, and this is a complaint I've heard from others as well. So I started looking into it.<br/>
<br/>
<p><br/>
With a help of <a href="http://linux.die.net/man/8/tc">artificial delay</a> induced to my network interface and several custom scripts to probe into the running processes, I was able to understand what was going on and make some good improvements.<br/>
<br/>
<p><br/>
First, in Maven plugin 2.0, we've made a change in the way we archive artifacts from Maven. Previously, the artifacts were copied between the master and the Maven JVM, and for a reason I'll mention later, this was very slow, especially in a network that has a large latency. With Maven plugin 2.0 and onward, artifacts are archived between the master and the slave JVM.<br/>
<br/>
<p><br/>
The second problem that I discovered was that the spy program we put inside Maven is causing excessive amount of unnecessary classloading. Some classes have static initializers that too eagerly refer to other classes, which in turn brings in other classes, and so on. Despite <a href="http://jenkins-ci.org/content/faster-slave-classloading">the jar file caching that we do</a>, these classloading still sometimes requires precious roundtrips to the master, which costs in the order of 10s of ms. I was able to make various changes in Jenkins core to cut this down, and these fixes will land in Jenkins 1.559 (ETA is April 14th.) The classloading overhead is independent of the size of your Maven build, so this improvement is more for people who have lots of small Maven builds, like <a href="https://ci.jenkins-ci.org/">Jenkins building Jenkins plugins</a>.<br/>
<br/>
<p><br/>
Now, on to the biggest fruit of this investigation I was able to discover and fix. Imagine the Maven JVM has a lot of data to send to the master, say you are archiving test reports or code coverage report. A good implementation would send these data as fast as ppossible to the master, paying respect to the limit of flow control to avoid overwhelming the master.<br/>
<br/>
<p><br/>
It turns out that the way we set up this communication channel was far from optimal. Instead of having the Maven JVM push data with flow control, we were relying on the master to pull data. That is, master has to send out a request to the slave to fetch the next batch of data (8KB), then once it receives that data, it sends out another request to fetch the next batch of data, and so on. If your network latency is 10ms, this scheme only lets us send 500KB/sec, even if you have a gigabit ethernet. No wonder it was so slow!<br/>
<br/>
<p><br/>
This fix is in in Maven plugin 2.2. See <a href="https://issues.jenkins-ci.org/browse/JENKINS-22354">JENKINS-22354</a> if you want to know more about the actual diffs and such.<br/>
<br/>
Unfortunately, none of these are available for those who are on 1.532.x LTS, but <a href="http://meetings.jenkins-ci.org/jenkins/2014/jenkins.2014-04-02-18.02.html">the next 1.554.1 LTS</a> will be able to run the newer Maven 2.2 plugin. So the help is on the way!<br/>
<br/>

</div>
</div>

<div id='content-bottom'>
</div>
</div>
<script>
  !function(d,s,id) {
    var js, fjs=d.getElementsByTagName(s)[0];
    if (!d.getElementById(id)) {
      js = d.createElement(s);
      js.id=id;
      js.src="//platform.twitter.com/widgets.js";
      fjs.parentNode.insertBefore(js,fjs);
    }
  }(document,"script","twitter-wjs");
</script>

<div id='github'>
<a href='https://github.com/rtyler/jenkins.io/edit/master/content//blog/2014/2014-04-04-maven-job-type-performance-improvements-in-maven-plugin-2-2.html' title='Edit /blog/2014/2014-04-04-maven-job-type-performance-improvements-in-maven-plugin-2-2.html on GitHub'>
Improve this page
</a>
</div>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){

                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),

                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)

                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-4216293-5', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

</body>
</html>
