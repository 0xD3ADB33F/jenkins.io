<html>
<head>
<title>
Pipeline-as-code with Multibranch Workflows in Jenkins
</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<meta content='Jenkins is an open source automation server' name='description'>
<link href='/css/style.css' media='screen' rel='stylesheet'>
</head>
<body>
<a href='https://github.com/jenkinsci'>
<img alt='Fork us on GitHub' src='https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png' style='position: absolute; top: 0; right: 0; border: 0;'>
</a>
<div class='clearfloat' id='head'>
<div class='clearfloat'>
<div id='logo'>
<a href='/' title='Jenkins'>
<img src='/images/header_logo.png'>
</a>
<div id='tagline'>
An extendable open source automation server
</div>
</div>
</div>
<!-- starting partial navbar.html.haml -->
<div class='clearfloat' id='navbar'>
<div id='page-bar'>
<ul class='menu'>
<li class='leaf first'>
<a href='/node' title='Blog landing page'>
Blog
</a>
</li>
<li class='expanded'>
<a href='/' title=''>
Connect
</a>
<ul class='menu'>
<li class='leaf first'>
<a href='/content/mailing-lists' title='Browse Jenkins mailing list archives and/or subscribe to lists'>
Mailing Lists
</a>
</li>
<li class='leaf'>
<a href='/content/chat' title='Chat with the rest of the Jenkins community on IRC'>
Chat
</a>
</li>
<li class='leaf'>
<a href='http://twitter.com/jenkinsci' title='Check out @jenkinsci on Twitter'>
Twitter
</a>
</li>
<li class='leaf'>
<a href='/content/event-calendar' title='Calendar for Jenkins events'>
Event Calendar
</a>
</li>
<li class='leaf'>
<a href='https://wiki.jenkins-ci.org/display/JENKINS/Office+Hours' title='WebEx-based online meeting'>
Office Hours
</a>
</li>
<li class='leaf last'>
<a href='https://reddit.com/r/jenkinsci' title='Check out the latest links and news on jenkinsci.reddit.com!'>
reddit
</a>
</li>
</ul>
</li>
<li class='leaf'>
<a href='https://wiki.jenkins-ci.org/display/JENKINS/Issue+Tracking' title='JIRA for Jenkins'>
Bug Tracker
</a>
</li>
<li class='leaf'>
<a href='http://wiki.jenkins-ci.org/' title='Main documentation of Jenkins'>
Wiki
</a>
</li>
<li class='leaf'>
<a href='http://ci.jenkins-ci.org/' title='Jenkins and plugins built on Jenkins'>
CI
</a>
</li>
<li class='leaf'>
<a href='https://wiki.jenkins-ci.org/display/JENKINS/Donation' title=''>
Donation
</a>
</li>
</ul>
</div>
</div>

<!-- ending partial navbar.html.haml -->
</div>
<div class='clearfloat' id='page'>
<div class='clearfloat' id='top'>
<div id='sidebar'>
<!-- starting partial sidebar.html.haml -->
<div class='block block-block even' id='block-block-5'>
<h3>
What is Jenkins?
</h3>
<div class='content'>
<p>
In a nutshell, Jenkins is the leading open source automation server.
Built with Java, it provides
<strong>
hundreds
</strong>
of plugins to support building, testing, deploying and automation
virtually any project
</p>
</div>
</div>
<!-- starting partial download.html.haml -->
<link href='/css/download.css' media='screen' rel='stylesheet'>
<link href='/assets/bower/jquery-ui/themes/base/all.css' media='screen' rel='stylesheet'>
<script src='/assets/bower/jquery/jquery.min.js'></script>
<script src='/assets/bower/jquery-ui/jquery-ui.min.js'></script>
<div class='block block-block even' id='block-block-15'>
<h3>
Download
</h3>
<div class='content'>
<div id='download-tabs'>
<ul class='tab-bar'>
<li>
<a href='#release'>
Release
</a>
</li>
<li>
<a href='#stable'>
Long-Term Support Release
</a>
</li>
</ul>
<div class='tab' id='release'>
<dl>
<dt>
Java Web Archive (.war)
</dt>
<dd>
<div>
<a href='http://mirrors.jenkins-ci.org/war/latest/jenkins.war'>
<strong>
Latest:
1.642
</strong>
</a>
</div>
<div class='release-block-small'>
<a href='/changelog'>
changelog
</a>
|
<a href='http://mirrors.jenkins-ci.org/war/'>
past releases
</a>
</div>
</dd>
<dt>Native packages</dt>
<dd class='release-block-platforms'>
<div>
<img src='/images/os/win_other.png'>
<a class='release-block-soft' href='http://mirrors.jenkins-ci.org/windows/latest' onclick="return download('http://jenkins-ci.org/content/thank-you-downloading-windows-installer')">Windows</a>
</img>
</div>
<div>
<img src='/images/os/ubuntu.png'>
<a class='release-block-soft' href='http://pkg.jenkins-ci.org/debian/'>Ubuntu/Debian</a>
</img>
</div>
<div>
<img src='/images/os/redhat.png'>
<a class='release-block-soft' href='http://pkg.jenkins-ci.org/redhat/'>Red Hat/Fedora/CentOS</a>
</img>
</div>
<div>
<img src='/images/os/os_macosx.png'>
<a class='release-block-soft' href='http://mirrors.jenkins-ci.org/osx/latest' onclick="return download('http://jenkins-ci.org/content/thank-you-downloading-os-x-installer')">Mac OS X</a>
</img>
</div>
<div>
<img src='/images/os/opensuse.png'>
<a class='release-block-soft' href='http://pkg.jenkins-ci.org/opensuse/'>openSUSE</a>
</img>
</div>
<div>
<img src='/images/os/freebsd.png'>
<a class='release-block-soft' href='http://www.freshports.org/devel/jenkins'>FreeBSD</a>
</img>
</div>
<div>
<img src='/images/os/os_openbsd.png'>
<a class='release-block-soft' href='http://openports.se/devel/jenkins/devel'>OpenBSD</a>
</img>
</div>
<div>
<img src='/images/os/os_gentoo.png'>
<a class='release-block-soft' href='http://code.google.com/p/godin-gentoo-repository/wiki/Jenkins'>Gentoo</a>
</img>
</div>
</dd>
<dt>Docker</dt>
<dd id='release-block-platforms'>
<div>
<a class='release-block-soft' href='https://registry.hub.docker.com/u/jenkinsci/jenkins/'>
<tt>docker pull jenkinsci/jenkins</tt>
</a>
</div>
</dd>
</dl>
</div>
<div class='tab' id='stable'>
<dl>
<dt>Java Web Archive (.war)</dt>
<dd style='margin-bottom:1em'>
<div>
<a href='http://mirrors.jenkins-ci.org/war-stable/latest/jenkins.war'>
<strong>
Older but stable:
1.625.3
</strong>
</a>
</div>
<div class='release-block-small' style='text-align:right'>
<a class='release-block-soft' href='/changelog-stable'>changelog</a>
|
<a class='release-block-soft' href='http://mirrors.jenkins-ci.org/war-stable/'>past releases</a>
|
<a class='release-block-soft' href='/stable-rc'>RC</a>
</div>
<br>
<div style='text-align:right'>
<a href='https://wiki.jenkins-ci.org/display/JENKINS/LTS+Release+Line'>
<strong>What is LTS?</strong>
</a>
</div>
</dd>
<dt>Native packages</dt>
<dd class='release-block-platforms'>
<div>
<img src='/images/os/win_other.png'>
<a class='release-block-soft' href='http://mirrors.jenkins-ci.org/windows-stable/latest' onclick="return download('http://jenkins-ci.org/content/thank-you-downloading-windows-installer?releaseLine=-stable')">Windows</a>
</img>
</div>
<div>
<img src='/images/os/ubuntu.png'>
<a class='release-block-soft' href='http://pkg.jenkins-ci.org/debian-stable/'>Ubuntu/Debian</a>
</img>
</div>
<div>
<img src='/images/os/redhat.png'>
<a class='release-block-soft' href='http://pkg.jenkins-ci.org/redhat-stable/'>Red Hat/Fedora/CentOS</a>
</img>
</div>
<div>
<img src='/images/os/os_macosx.png'>
<a class='release-block-soft' href='http://mirrors.jenkins-ci.org/osx-stable/latest' onclick="return download('http://jenkins-ci.org/content/thank-you-downloading-os-x-installer?releaseLine=-stable')">Mac OS X</a>
</img>
</div>
<div>
<img src='/images/os/opensuse.png'>
<a class='release-block-soft' href='http://pkg.jenkins-ci.org/opensuse-stable/'>openSUSE</a>
</img>
</div>
<div>
<img src='/sites/default/files/images/freebsd.png'>
<a class='release-block-soft' href='http://www.freshports.org/devel/jenkins-lts'>FreeBSD</a>
</img>
</div>
<div>
<img src='/images/os/os_openbsd.png'>
<a class='release-block-soft' href='http://openports.se/devel/jenkins/stable'>OpenBSD</a>
</img>
</div>
<div>
<img src='/images/os/os_gentoo.png'>
<a class='release-block-soft' href='http://code.google.com/p/godin-gentoo-repository/wiki/Jenkins'>Gentoo</a>
</img>
</div>
</dd>
</dl>
<dt>Docker</dt>
<dd id='release-block-platforms'>
<div>
<a class='release-block-soft' href='https://registry.hub.docker.com/_/jenkins/'>
<tt>docker pull jenkins</tt>
</a>
</div>
</dd>
</div>
</div>
</div>
</div>
<script>
  $(function(){
    if (window.location.pathname == '/changelog-stable' || window.location.pathname == '/stable-rc') {
      $("#download-tabs").tabs({ selected: 1 });
    } else {
      $("#download-tabs").tabs();
    }
    $("#download-tabs, #download-tabs .ui-tabs-nav, #download-tabs .ui-tabs-nav > *" )
      .removeClass( "ui-corner-all ui-corner-top" );
  });
  
  function download(href) {
    window.location = href;
    return false;
  }
</script>
<style>
  .ui-widget { font-family: inherit !important; }
  .ui-widget-content { color:inherit !important; }
  .ui-widget-content .tab a { color: #D24939 !important; }
</style>

<!-- ending partial download.html.haml -->
<!-- starting partial book.html.haml -->
<div class='block block-block even' id='block-block-15'>
<div class='content'>
<center>
<a href='http://www.wakaleo.com/books/jenkins-the-definitive-guide'>
<img alt='Jenkins: The Definitive Guide' border='0' src='http://agentdero.cachefly.net/continuousblog/images/jenkins-cover-small.png' width='220'>
</a>
<br>
<a href='http://oreilly.com/catalog/0636920010326'>
<strong>
Buy the book!
</strong>
</a>
</center>
</div>
</div>

<!-- ending partial book.html.haml -->
<!-- starting partial resources.html.haml -->
<div class='block block-block odd' id='block-block-8'>
<h3>
Resources
</h3>
<div class='content'>
<big>
<p>
<a href='/calendar'>
Calendar
</a>
</p>
<p>
<a href='https://wiki.jenkins-ci.org/'>
Wiki
</a>
</p>
<p>
<a href='https://issues.jenkins-ci.org/'>
Issues
</a>
</p>
<p>
<a href='http://ci.jenkins-ci.org/'>
Jenkins-on-Jenkins
</a>
</p>
</big>
</div>
</div>

<!-- ending partial resources.html.haml -->

<!-- ending partial sidebar.html.haml -->
</div>
<div class='main-content with-sidebar' id='content'>
<div id='content-top'>
<div class='node clear-block'>
<h1>
<a href='/blog/2015/12/03/pipeline-as-code-with-multibranch-workflows-in-jenkins/' title='Pipeline-as-code with Multibranch Workflows in Jenkins'>
Pipeline-as-code with Multibranch Workflows in Jenkins
</a>
</h1>
<span class='submitted'>
Published on
2015-12-03T00:00:00+00:00
</span>
<!-- starting partial tweetbutton.html.haml -->
<div style='float: right; clear: all;'>
<a class='twitter-share-button' data-lang='en' href='https://twitter.com/share'>
Tweet
</a>
</div>

<!-- ending partial tweetbutton.html.haml -->
<div class='content'>
<p><em>Note: This is a guest post by <a href="https://github.com/kishorebhatia">Kishore Bhatia</a>. <a href="https://twitter.com/BhatiaKishore">Kishore</a> works for <a href="https://www.cloudbees.com">CloudBees</a>, building custom frameworks with Open Source software and helping customers solve engineering problems around continuous delivery and DevOps at scale.</em></p>

<hr />

<p>This year some great new Jenkins features came out of the butler’s goodie bag - amongst them, the most important one being the ability to realize <a href="https://www.voxxed.com/blog/2015/06/kohsuke-kawaguchi-the-main-challenge-for-jenkins-is-with-itself/">continuous delivery pipeline as code</a>!
The features like Workflow Multibranch, pipeline-as-code (with a marker file that Jenkins looks for in your application’s SCM repository/branch, aptly named Jenkinsfile) are the foundations to making Jenkins super intelligent to automagically create workflows (rather, a CI/CD pipeline) to build your code and orchestrate the work required to drive your application from concept to delivery!</p>

<h3 id="overview">Overview</h3>

<p>The Workflow Multibranch feature (provided by the <a href="https://github.com/jenkinsci/workflow-plugin">workflow plugin</a>) provides the following key abilities:</p>

<ul>
  <li>Automatic Workflow (job) creation in Jenkins per new branch in the repo.</li>
  <li>Build specific to that child-branch and its unique scm change and build history.</li>
  <li>Automatic job pruning/deletion for branches deleted from the repository, according to the settings.</li>
  <li>Flexibility to individually configure branch properties, by overriding the parent properties, if required.</li>
</ul>

<p>Jenkins pipeline-as-code (concept) enables you to maintain your CI/CD workflow logic in the project/application source code repo with no additional configuration to be maintained per branch in Jenkins.</p>

<p>The Workflow script to build/test/deploy your code is always synchronized with the rest of the source code you are working on.</p>

<p><strong>To demonstrate the concept here</strong> - Let’s use a basic Java Web application project with a Maven pom.xml as shown in the structure below (this is using GitHub as the SCM but you can do this on SVN or Mercurial too).</p>

<p><a href="https://github.com/kishorebhatia/pipeline-as-code-demo">This project</a> has a marker file for Jenkins in the repo - <code>Jenkinsfile</code>.</p>

<center><a href="http://agentdero.cachefly.net/continuousblog/pipeline-as-code-guest-blog/Pic1.png"><img src="http://agentdero.cachefly.net/continuousblog/pipeline-as-code-guest-blog/Pic1.png" width="600" border="0" /></a></center>

<p><strong>So, what's a Jenkinsfile?</strong> The <a href="https://github.com/kishorebhatia/pipeline-as-code-demo/blob/master/Jenkinsfile">Jenkinsfile</a> is essentially your Jenkins Workflow, a script, that defines the CI/CD pipeline logic for a project with steps to build/test/deploy etc. captured in various stages.</p>

<p>So for our sample Java web application, a basic Jenkinsfile could be something like -</p>

<p><code>&lt;pre&gt;
node {
   // Mark the code checkout 'stage'....
   stage 'Checkout'</code></p>

<p>// Checkout code from repository
   checkout scm</p>

<p>// Get the maven tool.
   // ** NOTE: This 'M3' maven tool must be configured
   // **       in the global configuration.         <br />
   def mvnHome = tool 'M3'</p>

<p>// Mark the code build 'stage'….
   stage 'Build'
   // Run the maven build
   sh "${mvnHome}/bin/mvn clean install"
}
&lt;/pre&gt;&lt;/code&gt;</p>

<p>Just having this file in the source code repo root would mean that -</p>

<ul>
  <li>Jenkins will automatically recognize this branch and create appropriate jobs by itself.</li>
  <li>Quick, 1-step code checkout using: “checkout scm” in your workflow</li>
  <li>Every time a new change is pushed to this branch, the branch is built and the commit status gets updated.</li>
  <li>When the branch is destroyed in the repository, or if Jenkinsfile is removed, the corresponding job gets destroyed from Jenkins automatically (<em>You can retain these jobs and/or archive the builds for audit/compliance requirements using the retention property - Orphan Item strategy</em>)</li>
</ul>

<p><em>Note:</em> there are various mechanisms to promote reuse of Workflow scripts, such as the <a href="https://github.com/jenkinsci/workflow-plugin/blob/master/cps-global-lib/README.md">Workflow Global Library</a>.</p>

<h3 id="required-jenkins-configuration">Required Jenkins configuration</h3>

<p>Make sure you’ve the latest <a href="https://github.com/jenkinsci/workflow-plugin">Workflow</a> and (v1.11 as of writing this blog) Workflow Multibranch plugins installed on your Jenkins instance</p>

<center><a href="http://agentdero.cachefly.net/continuousblog/pipeline-as-code-guest-blog/Pic2.png"><img src="http://agentdero.cachefly.net/continuousblog/pipeline-as-code-guest-blog/Pic2.png" width="600" border="0" /></a></center>

<p>Also, ensure that other dependencies, like SCM plugins and build tools, are met:</p>

<ul>
  <li>Either SVN/Git/Mercurial (depending on your SCM)</li>
  <li>GitHub Branch Source Plugin (optimized to use the GitHub API and improve performance)</li>
  <li>Maven build tool</li>
</ul>

<p>Then create a new <em>Multibranch Workflow</em> Job with configuration as shown below - mainly selecting the Branch Sources (Git, in this example) and providing the branch/repo URL with credentials.</p>

<p><em>Branch sources</em> (Git) - <code>https://github.com/kishorebhatia/pipeline-as-code-demo</code> (or a repo where you’ve cloned this source code with Jenkinsfile)</p>

<p>Leave all other properties default and <em>Save</em>.</p>

<center><a href="http://agentdero.cachefly.net/continuousblog/pipeline-as-code-guest-blog/Pic3.png"><img src="http://agentdero.cachefly.net/continuousblog/pipeline-as-code-guest-blog/Pic3.png" width="600" border="0" /></a></center>

<p>You’ll observe that Jenkins would perform Branch Indexing on that “cd” job folder and start the workflow for the master branch, with an automatically created new job, named master, under the “cd” folder.</p>

<p>The workflow does a dummy step for application deploys to the environments in this sequence <em>Staging</em> -&gt; Waits for manual approval -&gt; <em>PROD</em></p>

<p>Now, let’s create a new branch off of this master branch in your cloned git repo:</p>

<ul>
  <li><code>$ git branch newBranch</code> (create a newBranch)</li>
  <li><code>$ git checkout newBranch</code> (switches to newBranch)</li>
  <li><code>$ git push --set-upstream origin newBranch</code> (pushes newBranch)</li>
</ul>

<p>You’ll observe that your Jenkins instance automatically picks up this newBranch and starts running the workflow (with the Jenkinsfile in this newBranch) to build/test/deploy the code.</p>

<center><a href="http://agentdero.cachefly.net/continuousblog/pipeline-as-code-guest-blog/Pic4.png"><img src="http://agentdero.cachefly.net/continuousblog/pipeline-as-code-guest-blog/Pic4.png" width="600" border="0" /></a></center>

<p>Next, if you now delete this <code>newBranch</code> (<code>git branch -D newBranch</code>), Jenkins will automatically remove the orphan Workflow job for <code>newBranch</code>. You can retain these jobs even after the branches are deleted using the <em>Orphaned Item Strategy</em> property in the main "cd" job’s configuration.</p>

<p>So we observed the following benefits of this pipeline-as-code approach:</p>

<ul>
  <li>Overall job definition is a script (Jenkinsfile)</li>
  <li>Calls your build tools and scripts for details</li>
  <li>The build script can be versioned alongside project sources</li>
  <li>Jenkins handles feature/experimental branches automatically</li>
  <li>Keep less configuration in $JENKINS_HOME</li>
</ul>

<h3 id="dockerized-demo-environment">Dockerized Demo environment</h3>

<p>You can also use the following docker image to run this demo with a preconfigured Jenkins environment and the sample job: <code>jenkinsci/workflow-demo</code> (i.e. <code>docker pull jenkinsci/workflow-demo</code>)</p>

<p>This docker container includes Jenkins with Workflow and Workflow Multibranch plugins, a local git repo with the aforementioned Java web application and Jetty to demonstrate a continuous delivery pipeline of this application deployed and tested across multiple environments in the pipeline with an approval gate before promoting to PROD (like QA, Staging and PROD).</p>

<p>There's a "cd" job pre-configured as a multibranch Workflow job.</p>

<p>Launch the docker demo as: <code>docker run -p 8080:8080 -p 8081:8081 -p 9418:9418 -ti jenkinsci/workflow-demo</code></p>

<p>Now, you can access Jenkins on port 8080 and Jetty on port 8081 from localhost or the IP of your boot2docker/docker-machine environment.</p>

<p>The demo container has a local git repo so you can clone: <code>git://localhost/repo</code>. When creating new branches, each branch automatically creates a matching subproject in Jenkins and triggers the build for that branch. The workflow:</p>

<ul>
  <li>Checks out source code from the same repository and commit as <code>Jenkinsfile</code>.</li>
  <li>Builds sources via Maven with unit testing.</li>
  <li>Runs two parallel integration tests that involve deploying the app to ephemeral server instances, which get thrown away when tests are done (this is done by using auto-deployment of Jetty)</li>
  <li>Once integration tests are successful, the webapp gets to the staging server at <a href="http://localhost:8081/staging/">localhost:8081/staging</a> (or your docker-machine/boot2docker instance IP)</li>
  <li>requires a human to Manually inspect the staging instance, and when ready, approves the deployment to the production server at http://localhost:8081/production/</li>
</ul>

<h3 id="references">References</h3>

<ul>
  <li><a href="http://developer-blog.cloudbees.com/2015/08/workflow-19-and-multibranch-beta.html">Developer blog by jglick introducing multibranch support</a></li>
  <li><a href="https://github.com/jenkinsci/workflow-plugin/blob/master/TUTORIAL.md">workflow plugin tutorial</a></li>
  <li><a href="https://github.com/jenkinsci/workflow-plugin#presentations">workflow plugin presentations</a></li>
  <li><a href="https://github.com/jenkinsci/workflow-plugin/blob/master/demo/README.md">workflow plugin readme</a></li>
</ul>

</div>
</div>

<div id='content-bottom'>
</div>
</div>
<!-- starting partial footer.html.haml -->
<script>
  !function(d,s,id) {
    var js, fjs=d.getElementsByTagName(s)[0];
    if (!d.getElementById(id)) {
      js = d.createElement(s);
      js.id=id;
      js.src="//platform.twitter.com/widgets.js";
      fjs.parentNode.insertBefore(js,fjs);
    }
  }(document,"script","twitter-wjs");
</script>

<!-- ending partial footer.html.haml -->
<div id='github'>
<a href='https://github.com/jenkins-infra/jenkins.io/edit/master/content//blog/2015/2015-12-03-pipeline-as-code-with-multibranch-workflows-in-jenkins.md' title='Edit /blog/2015/2015-12-03-pipeline-as-code-with-multibranch-workflows-in-jenkins.md on GitHub'>
Improve this page
</a>
</div>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){

                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),

                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)

                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-4216293-5', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

</body>
</html>
